\def\Supp{\mathsf{Supp}\xspace}
\newcommand{\barcalS}{\bar{\cal S}\xspace}
\renewcommand{\brp}{{(p)}}
\renewcommand{\br}[1]{{(#1)}}
\renewcommand{\brp}{{(p)}}
\renewcommand{\br}[1]{{(#1)}}
\renewcommand{\bc}{{\bar c}}
\newcommand{\brt}{{(t)}}
\def\cc{\tilde{c}}
\newcommand{\barD}{\bar{D}}
\def\calFr{\calF^{(\alpha,\beta)}}
%\newpage
\section{Supply Polyhedra for \cckp: Proof of Theorem~\ref{fthm:conflp}}\label{fsec:conflp}
%Let the instance $\calI$ of $Q||C_{min}$  have $m$ machines $M$ with demands $D_1 \geq \cdots \geq D_m$ and cardinality constraints $f_1,\ldots,f_m$, and $n$ types of  jobs $J$ with capacities $c_1 \geq \cdots \geq c_n$.  We assume $D_1/D_m \leq n^C$\comment{deepc: i think this can be made wlog with some std trick}
%A supply vector $(s_1,\ldots,s_n)$ indicates the number of jobs of each type available; a supply vector is feasible if together they can satisfy all the demands.
%An $\alpha$-approximate supply polyhedra $\calP$ has the following properties: any feasible supply vector lies in $\calP$, and given any integral vector $(s_1,\ldots,s_n) \in \calP$ there is an allocation
%of the $s_j$ jobs of capacity $c_j$ which satisfies every demand up to an $\alpha$-factor.
%%We wish to find a convex set/polyhedra which captures all the feasible supply vectors. In particular, any feasible supply vector should be in the set, and given any (integer) supply vector in the set
%%there should be an allocation which satisfies the demands to an $\alpha$-factor.
%\smallskip
%
%\noindent
%A feasible supply vector $(s_1,\ldots,s_n)$ must lie in the following polytope.
%Let $\Supp$ be a set indicating infinitely many copies of all jobs.
%For every machine $i$, let $\calF_i :=\{S\in \Supp: |S| \leq f_i ~\textrm{ and } \sum_{j\in S} c_j \geq D_i\}$ denote all the feasible sets that can satisfy machine $i$.
%Let $n(S,j)$ denote the number of copies of job of type $j$.
%	\begin{alignat}{4}
%		\calP_\mathsf{conf} && = \{(s_1,\ldots,s_n):  && \notag \\
%		&& \quad \forall i \in M,   &\quad  \textstyle \sum_{S} z(i,S)  =  1 \label{feq:conflp1} \\
%		&& \quad \forall j\in J ,  &\quad  \textstyle \sum_{i\in M,S}  z(i,S)n(S,j) \le  s_j \label{feq:conflp2} \\
%		&& \quad \forall i\in M, S\notin \calF_i, & \quad z(i,S)  = 0 \label{feq:conflp3}  \}
%	\end{alignat}
\def\z{\bar z}
%\begin{theorem}\label{fthm:conflprounding}
%\end{theorem}
%\begin{proof}
	    Throughout the proof we fix $\calI$ to be the instance of \cckp and the supply vector $(s_1,\ldots,s_n)$.
	    Let  $z$ be a feasible solution to \eqref{feq:conflp1}-\eqref{feq:conflp3}. The proof of Theorem~\ref{fthm:conflp} follows from
	    Lemma~\ref{flem:conf-round}, Lemma~\ref{flem:conf-is-uf}, and Lemma~\ref{flem:conf-so}
	    \begin{lemma}\label{flem:conf-round}
	    	Given $z$, we can  find an of assignment of the $s_j$ jobs of capacity $c_j$  to the machines such that for all $i\in M$
	    	receives a total capapcity $\geq D_i/\alpha$ for $\alpha = O(\log D)$ where $D = D_\mathrm{max}/D_\mathrm{min}$.
	    \end{lemma}
	    \begin{proof}
%	    Our objective is to find an assignment of the $s_j$ jobs of capacity $c_j$ to the $m$ machines so that machine $i$ obtains total capacity $\geq D_i/\alpha$ for $\alpha = O(\log D)$. 	
	    We start by classifying the demands into buckets.
	
	    	\paragraph{Bucketing Demands.} We partition the demands into buckets depending on their requirement values $D_i$. By scaling data, we may assume without loss of generality that $D_\mathrm{min} = 1$.
	    	We say that demand $i$ belongs to \emph{bucket $t$} if $2^{t-1} \leq D_i < 2^t$. We let $B^\brt$ to denote the bucket $t$. The number of buckets $K \leq \log_2 D$.
	    	For any bucket $t$, we round-down all the demands for $i\in B^\brt$; define $\barD_i = 2^{t-1}$ for all $i\in B^\brt$. Note that any $\rho$-approximate feasible solution with respect to $\barD$'s is $2\rho$-approximate with respect to the original $D_i$'s. \smallskip
	
	
	
	
\noindent
  To this end, we modify the feasible solution $z$ to a solution $\z$  in various stages. Initially $\z \equiv z$.
	    Our modified solution $\z$'s support will not be $\calF_i$; to this end we define $\calFr_i$ for parameters $\alpha,\beta \geq 1$.
	    \begin{definition}
For machine $i$ and parameters $\alpha,\beta > 1$, $\calFr_i$ contains the set $S$ if either (a) $S = \{j\}$ is a singleton with $c_j \geq \frac{\barD_i}{3\log_2 D}$,
or (b) $|S|\leq f_i$, $c_j \leq \alpha \cdot \frac{\barD_i}{3\log_2 D}$, and $\sum_{j\in S} c_j \geq \frac{\barD_i}{\beta}$. 	    We say $\z$ is $(\alpha,\beta)$-feasible if for all $i$, $\z(i,S) > 0$ implies $S\in \calFr_i$.
	    \end{definition}
	    \noindent

	    \medskip
	
		\noindent {\bf Step 1: Partitioning Configurations.}	
		
		We call a job of capacity $c_j$ {\em large} for machine $i$ if $c_j \geq \frac{\barD_i}{3\log_2 D}$, otherwise we call it \emph{small} for machine $i$.
%		For a machine $i$, we define a relaxed collection of feasible sets $\calFr_i$ where $S\in \calFr_i$ if either (a) $S = \{j\}$ and $j$ is large for $i$, or (b) $c_j < \frac{D_i}{3\log_2 D}$ for all $j\in S$, $|S| \leq f_i$, and $\sum_{j\in S} c_j \geq D_i/2$.
%	
%		
%
%%		
%			Let $\Delta$ be a large enough constant.
%				For every machine $i$, let $\calFr_i$ denote the subsets $S\subseteq \Supp$ with $|S|\leq f_i$ but $\sum_{j\in S} c_j \geq D_i/4\Delta^2$.
%				
%		%First we round the quantities $c_p$ and $D_j$ down to nearest power of $\Delta$, and let the rounded quantities be $\bc_p$ and $\barD_j$ respectively.
%	   We call a configuration $S\subseteq \Supp$ large for $i$ if $z(i,S) > 0$ and $S$ contains a large job for $i$. Otherwise it is called small.
%
%Our first step is  to modify $z$ such that its support $z(i,S) > 0$ for only $S\in \calFr_i$ for all $i$.
For every machine $i$, if $z(i,S) > 0$ and $S$ contains any large job $j$ for $i$, then we replace $S$ by $\{j\}$. To be precise, we set $\z(i,\{j\}) = z(i,S)$ and $\z(i,S) = 0$.
We call such singleton configurations {\em large} for $i$; all others are {\em small}. %Note that after this step, $z(i,S) > 0$ only for $S\in \calFr_i$.
Let $\calF^L_i$ be the collection of large configurations for $i$; the rest $\calF^S_i$ being small configurations.
Define $\z^L(i) := \sum_{S\in \calF^L_i} \z(i,S)$ be the total large contribution to $i$, and let $\z^S(i) := \sum_{S\in \calF^S_i} \z(i,S)$ the small contribution.

\begin{claim}\label{fclm:step1}
	After {\bf Step 1}, $\z$ satisfies \eqref{feq:conflp1} and \eqref{feq:conflp2} and $\z$ is $(1,1)$-feasible.
\end{claim}

 	
	
%	Our algorithm starts with a feasible fractional solution to the configuration LP, and over time modifies the solution to make \emph{most} of the \emph{large configuration assignments} integral $0/1$ while remaining feasible to a slightly \emph{relaxed} configuration LP. Finally, it rounds the small item types to $0/1$ using the classical algorithm of Lenstra, Shmoys and Tardos~\cite{LST}. Overall, the rounding algorithm requires several steps which we next present one by one.
%	

%	We also slightly expand the set of small and large configurations to satisfy some weaker conditions involving $\bc_p$ and $\barD_j$ as follows: we define a set $\barcalS^L_j$ of \emph{relaxed} large configurations to be $\barcalS^L_j = \{ \{p\} \text{ s.t } \bc_p \geq \frac{\barD_j}{4 \Delta^2}  \}$. Similarly, the expanded collection of \emph{relaxed} small configurations for demand $j$ is denoted by $\barcalS^S_j = \{ ((1,n'_1), (2,n'_2), \ldots, (P,n'_P)) \text{ s.t } \sum_{p \in [P]} \bc_p n'_p \geq \frac{\barD_j}{\Delta} \text{ and } \sum_{p \in [P]} n'_p \leq f_j \text{ and } n'_p \leq n_p \text{ for all } 1 \leq p \leq P \}$.
%	
%	\begin{claim}
%		The relaxed large and small configurations satisfy $\calS^L_j \subseteq \barcalS^L_j$ and $\calS^S_j \subseteq \barcalS^S_j$.
%	\end{claim}
%	
%	\begin{proof}
%		Since we scale down the demands and capacities by a factor of $\Delta$, it is easy to see.
%	\end{proof}
%	
%	\begin{corollary}
%		The solution $\{y(S,j)\}$ is feasible to the relaxed configuration LP where we allow relaxed large and small configurations.
%	\end{corollary}
%	
%	
%	\medskip % \noindent {\bf Step 2: ``Bucketing'' Demand Requirements.}
%	Before proceeding, we make a few definitions.
	We partition the demands into buckets depending on their requirement values $D_i$. By scaling data, we may assume without loss of generality that $D_{min} = 1$.
	We say that demand $i$ belongs to \emph{bucket $t$} if $2^{t-1} \leq D_i < 2^t$. We let $B^\brt$ to denote the bucket $t$. The number of buckets $K \leq \log_2 D$.
%		Note that the number of buckets $K \leq \log_2 D$; this drives the approximation factor.
%We make one observation.
%\begin{claim}\label{fclm:c001}
%	For any $t$, let $i$ and $i'$ be two machines in $B^\brt$ and let $f_i \leq f_{i'}$.
%	Let $z(i,T) > 0$ for some small configuration for $i$.
%Then $T\in \calFr_{i'}$ and $\sum_{j\in T} c_j \geq D_{i'}/2$.
%\end{claim}
%\begin{proof}
%Note that since $z(i,T) > 0$, we have $\sum_{j\in T} c_j \geq D_{i} \geq 2^{t-1} \ge D_{i'}/2$. Furthermore, for any $j\in T$, we have $c_j \leq \frac{D_{i}}{3\log_2 D} \le \frac{2^t}{3\log_2 D}$.
%Therefore any other machine $i'\in B^\brt$, $T$ satisfies two conditions of being in $\calFr_{i'}$.
%Now if $f_{i'} \geq f_i$, we get $|T| \leq f_{i'}$ as well.
%\end{proof}
%Before describing our subroutines, we make a few definitions. All of these are with respect to a solution $z$.


%At this stage, note that $\z^L(i) + \z^S(i) = 1$ for all machines $i$.		
A machine $i$ is called {\em rounded} if $\z(i,S) = 1$ for some set $S$. We let $\calR$ denote the rounded machines.
The remaining machines are of three kinds:  {\em large} ones with $\z^L(i) = 1$, {\em hybrid} ones with $\z^L(i) \in (0,1)$ and {\em small} ones with $\z^L(i) = 0$.
Let $\calL,\calH,\calS$ denote these respectively.  \medskip


\noindent{\bf Step 2: Taking care of large machines.}

The goal of this step is to modify $\z$ such that (a) the set of large machines becomes empty and (b) the set of hybrid machines is bounded. In particular, we will have at most one hybrid machine in a bucket
proving there are at most $K$ hybrid machines. First we need to discuss two sub-routines.

\paragraph{Subroutine: {\sf FixLargeMachine}($i$).}
This takes input a large machine $i\in\calL$, that is,  $\z^L(i) = 1$. We modify $\z$ such that at the end of the subroutine, among other things, $i$ gets rounded and enters $\calR$.

Consider the jobs $j$ large for $i$ such that $\z(i,\{j\}) \in (0,1)$. Since $\z^L(i) = 1$ and $i\notin \calR$, there exists at least two such jobs.
%
%Since $i\notin \calR$ in the beginning and yet $\z^L(i) = 1$, there must exist at least two large configurations $z(i,\{j\}) \in (0,1)$. % and $z(i,\{j_2\}) \in (0,1)$.
Let $j_1$ be the smallest capacity among these, and $j_2$  be any other such job. %all large configurations $(i,\{j\})$ with $z(i,\{j\}) > 0$.
%	Wlog, assume $c_{j_1} \le c_{j_2}$.
Two cases arise. In the simple case, there exists no $i'\notin \calR, S'\subseteq \Supp$ with $\z(i',S) > 0$ and $j_1 \in S$. That is, no other machine fractionally claims the job $j_1$.
Since $s_{j_1}$ is an integer, we have slack in \eqref{feq:conflp2}. We round up $\z(i,\{j_1\}) = 1$, set $\z(i,T) = 0$ for all other configurations of $i$, and add $i$ to $\calR$ and terminate.
%
%(zeroing out all other $i$'s $z(i,S)$'s ) without violating \eqref{feq:conflp2}. We then  add $(i,\{j_1\})$ to $\calR$.

Otherwise, there exists a machine $i'$
%(which could be in a different bucket)
and a set $S$ such that $z(i',S) \in (0,1)$ and $j_1 \in S$.
Now define the set $T$ as follows. If $c_{j_2} > \frac{\barD_{i'}}{3\log_2 D}$, then $T = \{j_2\}$; otherwise $T = S - j_1 + j_2$.
Note that in the second case $j_2$ could already be in $S$; $T$ then contains one more copy, that is, $n(T,j_2) = n(S,j_2) + 1$.
%Note that in either case $T \in \calFr_{i'}$.
%In the first case, $j_2$ is large for $i'$. In the second case, $|T| = |S|$ and $\sum_{j\in T} c_j \ge \sum_{j\in S} c_j$ since $c_{j_2} \geq c_{j_1}$ by choice of $j_1$.
We modify $\z$-as follows. We decrease $\z(i,\{j_2\})$ and $\z(i',S)$ by $\delta$, and increase $\z(i,\{j_1\})$ and $\z(i',T)$ by $\delta$ till one of the values becomes $0$ or $1$.
%As before, this preserves the LHS of \eqref{feq:conflp1} and can only decrease the LHS of \eqref{feq:conflp2} (for jobs $j\in S\setminus j_1$ if $T = \{j_2\}$).
%	Also note that $z^L(j)$ can only increase for any job; in particular no job leaves $\calL$. {\Huge NOT CORRECT}
%This process ends with assigning $z(i,\{j_1\}) = 1$ and we add $(i,\{j_1\})$ to $\calR$.
%If $\z(i',T)$ becomes $1$, we add $i'$ to $\calR$
If at any point, some configuration gets $\z$ value $1$, we add the corresponding machine to $\calR$.
We proceed till $i$ enters $\calR$.

\begin{claim}\label{fclm:002}
	{\sf FixLargeMachine}($i$) terminates. Upon termination, the solution $\z$ satisfies \eqref{feq:conflp1} and \eqref{feq:conflp2}, and
	if $\z$ was $(\alpha,\beta)$-feasible before the subroutine, it remains $(\alpha,\beta)$-feasible afterwards.
%	Furthermore, $i$ enters $\calR$.
\end{claim}
\begin{proof}
	If at any point we are in the simpler case, then $i$ enters $\calR$ and we terminate. Since we modify $\z(i,S)$ only for machine $i$, \eqref{feq:conflp1} is satisfied by the modification.
	\eqref{feq:conflp2} is satisfied for $j$ no other machine fractionally claims it. In the other case, note that the modification by $\delta$'s preserve the LHS of \eqref{feq:conflp1}. Furthermore, since $T\subseteq S\cup j_2$, it can only
	decrease the LHS of \eqref{feq:conflp2} (for jobs $j' \in S\setminus T\cup j_1$ when $T=\{j_2\}$ ). Finally, the new entry to the support of $\z$ is $\z(i',T)$ and we need to check $T\in \calFr_i$.
	If $T$ is a singleton (that is $j_2$), then $c_{j_2} \geq \frac{\barD_{i'}}{3\log D}$ and so $T\in \calFr_i$.
  Otherwise, since $S\in \calFr_i$, $c_{j_2} <  \frac{\barD_{i'}}{3\log D}$, and $c_{j_2} \geq c_{j_1}$ we have $T\in \calFr_i$.
  So at every step $\z$ maintains \eqref{feq:conflp1} and \eqref{feq:conflp2} and is $(\alpha,\beta)$-feasible. To argue termination, note that in the second case the value of $\z(i,\{j_1\})$ strictly goes up.
  In the end, we must have $\z(i,\{j_1\}) = 1$.
\end{proof}

\paragraph{Subroutine: {\sf FixBucket}($t$).} This takes input a bucket $t$ with more than one hybrid machine, and modifies the $\z$-solution such that
there is at most one hybrid machine in $t$. Recall a machine is hybrid if $\z^L(i) \in (0,1)$.
The $\z$-value for other machines in other buckets are unaffected.

%Let
%	{\bf Step 2: Rounding Large Demand Assignments.} In this step, we modify the LP solution
% such that for each bucket $t$, there is at most one hybrid machine $i\in B^{(t)}$ with  $z^L(i) \in (0,1)$.
%% and at most one $j$ with $c_j \geq D_i/4\Delta^2$  with $z(i,\{j\}) \in (0,1)$.
%% The flip side is that we may introduce variables $z(i,S)$ for sets $S$ where $|S|\leq f_i$ but $\sum_{j\in S} c_j \geq D_i/4\Delta^2$.
% %\emph{at most one strictly fractional variable} $0 < y_{S,j} < 1$ over all $j \in B^\brt$ and $S \in \barcalS^L_j$.
% To this end, we repeatedly perform the following steps, starting from the smallest bucket $t$ onwards.

%
% Before we start the steps for bucket $t$, we always maintain the following invariant holds for every bucket $t' < t$ (which is vacuously true for the smallest ($t=1$) bucket):
%	\begin{framed}
%		\begin{itemize}
%			\item[({\bf I})] For each bucket $t' < t$, there is at most one  demand $i_{t'} \in B^{(t')}$ %\setminus \calR$
%			such that $z^L(i_{t'}) \in (0,1)$. Further, if such a demand $i_{t'}$ exists, then $f_{i_{t'}} \leq f_{i}$ for all $i \in B^{(t')} \setminus \calR$.
%		\end{itemize}
%	\end{framed}
	
%	Suppose this invariant holds for all buckets upto $t-1$. Now we describe the iteration for bucket $t$.
	
Among the hybrid machines in $B^\brt$, let $i$  be the one with the smallest $f_i$. Let $i'$ be any other hybrid machine in this bucket. We know there is at least one more.
%	
%	
%	%\medskip \noindent {\bf Step 2a: Intra-Bucket Rounding.}
%	Define a total order $\prec$ on $B^\brt \setminus \calR$, where $i \prec i'$ if $f_{i} \leq f_{i'}$.
%	%We now ensure that the demands with the smallest $f_j$ value get preference when it comes to being satisfied by large configurations.
%	Suppose there exists $i,i' \in B^\brt \setminus \calR$ such that the following conditions hold: (i) $i\prec i'$, (ii) $z^L(i)$ and $z^L(i')$ are both in $(0,1)$.
	We now \emph{modify} $\z$ as follows.
	Since $\z^L(i') > 0$, there exists a large configuration $\{j'\}$ for $i'$ with $\z(i',\{j'\}) > 0$. Similarly, since $\z^L(i) < 1$, there must exist a {\em small} configuration $T$ with $\z(i,T) > 0$.
	%To this end, let $(S,j') \in \barcalS^L_{j'}$ be a large configuration  with $y(S,j') > 0$. Now, since $y^l(j) < 1$, we know that there is a small configuration $(T,j) \in \barcalS^S_j$ with $y(T,j) > 0$.
%	By Claim~\ref{fclm:c001}, note that $T\in \calFr_{i'}$ as well.
	We then perform the following change: decrease $\z(i',\{j'\})$ and $\z(i,T)$ by $\delta$, and increase $\z(i,\{j'\})$ and $\z(i',T)$ by $\delta$,  for a $\delta > 0$ such that one of the variables becomes 0 or 1.
	Note that this keeps \eqref{feq:conflp1} and \eqref{feq:conflp2} maintained. 	%In particular, no job $j$ leaves $\calL$.
	
	We keep performing the above step till bucket $t$ contains at most one hybrid machine.
	If at any point, some configuration gets $\z$ value $1$, we add the corresponding machine to $\calR$.
%	We keep on performing this process as long as possible; since we always transfer large configuration assignments to demands which appear earlier in the total order, this process will stop at some point. At this point, we add whichever demands are integrally assigned by large configurations to
%	the set $\calR$, i.e., all $i \in B^\brt$ for which   $z(i,S) = 1$ for some $S\in \calFr_i$ are added to $\calR$.
%	
%	\begin{claim} \label{fcl:swap1}
%		The modified solution above is feasible for the relaxed LP where support $z(i,S)$ is allowed for $S\in \calFr_i$.
%	\end{claim}
%	\begin{proof}
%		Since $i$ and $i'$ are in the same bucket, $c_{j'} \geq D_i/4\Delta^2$ as well, and so $\{j'\} \in \calFr_i$. Similartly, $\sum_{j\in T} c_j \geq D_{i'}/\Delta$. Furthermore, since $i\prec i'$, we have $|T| \leq f_{i} \leq f_{i'}$. Thus, the support of $z$ stays in the relaxed support. Finally, the LHS of \eqref{feq:conflp2} remains unchanged in the above operation for all jobs.
%%		
%%		
%%		To see why the modified solution is feasible for the relaxed configuration LP, observe that $(S,j)$ is also a valid relaxed large configuration because $j$ and $j'$ are of the same bucket $t$ and hence have the same rounded demand requirement of $\Delta^t$. Similarly, observe that $(T,j')$ is a valid small configuration for $j'$ because $|T| \leq f_{j} \leq f_{j'}$, and the remaining constraints for being a small configuration (i.e., the total capacity of items in $T$ should exceed the $\barD_{j'}/\Delta$, and the numbers $n(T,p) \leq n_p$ for all types) are satisfied trivially since they enforce the same constraints for $j$ and $j'$. As a result, since we increase $y(S,j)$ and decrease $y(T,j)$ at the same rate, constraint~\cref{feq:config1} is satisfied for $j$. Similarly, since we increase $y(T,j')$ and decrease $y(S,j')$ at the same rate, constraint~\cref{feq:config1} is satisfied for $j'$. Likewise, since we increase $y(S,j)$ and decrease $y(S,j')$ at the same rate, constraint~\cref{feq:config2} is satisfied for the item type corresponding to the large item in $S$. Finally, since we increase $y(T,j')$ and decrease $y(T,j)$ at the same rate, constraints~\cref{feq:config2} are satisfied for all item types corresponding to items in $T$.
%	\end{proof}
%	
\begin{claim}\label{fclm:step2}
	{\sf FixBucket}($t$) terminates. Upon termination, the solution $\z$ satisfies \eqref{feq:conflp1} and \eqref{feq:conflp2}, and
	if $\z$ was $(\alpha,\beta)$-feasible before the subroutine, it remains $(\alpha,\beta)$-feasible afterwards.
\end{claim}
	\begin{proof}
The possibly new entry to the support of $\z$ is $\z(i',T)$. Note that $|T| \leq f_i$ since $\z$ was $(\alpha,\beta)$-feasible to begin with,  and therefore $|T|\leq f_{i'}$ as well.
The other conditions of $(\alpha,\beta)$-feasibility are satisfied since $\barD_i = \barD_{i'}$, both being in the same bucket.
Also note that the LHS of both \eqref{feq:conflp1} and \eqref{feq:conflp2} remain unchanged.
To argue termination, till bucket $t$ contains more than one hybrid machine, note that $\z^L(i)$ increases for the hybrid machine $i$ with the smallest $f_i$.
	\end{proof}




%	The following claim encapsulates the state of affairs after taking care of the $t$th bucket.
%	
%	\begin{claim} \label{fcl:step3a}
%		Let $\alpha := z^L(B^\brt \setminus \calR)$ denote the total fractional assignment of large configurations to the non-integrally rounded demands in $B^\brt$. Then the following condition holds at the termination of the above iterative process: suppose we arrange the demands in $B^\brt \setminus \calR$ according to the order $\prec$. Let this ordering be $i_1, i_2, \ldots,i_r$, and let $k$ denote $\lfloor \alpha \rfloor$. Then we have that $z^L(i_u) = 1$ for $u=1, \ldots, k$, $z^L(i_u) = 0$ for $u > k+1$, and lastly, $z^l(i_{k+1})$ is equal to the fractional part of $\alpha = \alpha - \floor{\alpha}$.
%	\end{claim}
%	
%	\begin{proof}
%		Complete...
%	\end{proof}
	
%	\begin{claim}
%		After step (3a), the invariant (I) continues to hold for all buckets $t' < t$.
%	\end{claim}
%	
%	\begin{proof}
%		This is true because we do not alter the assignments in buckets $p' < p$ in the step.
%	\end{proof}
	
	
%	To summarize, after the above step, we have ensured that there is at most one demand (i.e., $j_{k+1}$ from the claim above) of bucket $t$
%	with strictly fractional $y^l(j)$ value in the modified LP solution. However, even the demands with $y^l(j) = 1$, i.e.,  $j_1, \ldots, j_k$,  may currently be satisfied by many large configurations. In the next step of the algorithm, we iteratively perform a \emph{second transformation} to ensure that each such demand is in fact \emph{integrally satisfied by a single large item}, and hence we can add such demands to $\calR$ and proceed.
%	
%	
	%{\Huge NEED TO FIX BELOW}
%   Note that Fix Large Machine can make a small machine $i'$ hybrid or large for its bucket since $z^L(i')$ could potentially increase.
\noindent
Now we have the two subroutines to describe {\bf Step 2} of the algorithm. It is the following while loop.
   \begin{itemize}[noitemsep]
   	\item[{}] While $\calL$ is non-empty:
   	\begin{itemize}[noitemsep]
   		\item If $i\in \calL$, then {\sf FixLargeMachine}($i$). Note that $i$ enters $\calR$ after this. This can increase the number of hybrid machines across buckets.
   		\item For all $1\leq t\leq K$, if $B^\brt$ contains more than one hybrid machine, then {\sf FixBucket}($t$). This can increase the number of machines in $\calL$.
   	\end{itemize}
   \end{itemize}

%   If there are more than one hybrid in any bucket, we apply Step 2 again. Since Step 3 moves machines to $\calR$, this process can go on for at most $m$ steps. After doing this sequence of steps, we have the following scenario.
%
	  Since the {\sf FixLargeMachine} adds a new machine to $\calR$, it cannot run more than $m$ times. Therefore, the while loop terminates. Furthermore, before the loop $\z$ is $(1,1)$-feasible satisfying \eqref{feq:conflp1} and \eqref{feq:conflp2} (Claim~\ref{fclm:step1}), therefore Claim~\ref{fclm:002} and Claim~\ref{fclm:step2} imply that it satisfies after the while loop. We encapsulate the above discussion in the following claim about Step 2.
   \begin{claim}\label{fclm:003}
   	{\bf Step 2} terminates. Upon termination, the modified LP solution $\z$ is $(1,1)$-feasible, satisfies \eqref{feq:conflp1} and \eqref{feq:conflp2}, and furthermore
   	$\calL$ is empty and for every bucket $t$ we have at most one hybrid machine $i\in B^\brt\setminus\calR$.
%   	At the end of {\bf Step 1}, we have for every bucket $t$, at most one  $i\in B^\brt\setminus\calR$ has $z^L(i) \in (0,1)$ and the rest have $z^S(i) = 1$. Furthermore, for every $i\in \calS$ and $z(i,S) > 0$,
%   	we have $\sum_{j\in S} c_j \geq D_i/2$.
   	\end{claim}
   	\smallskip
   	



%	We need to make sure that $S - j_1 + j_2$  lies in
%	Note that $S$ could already have one (or more) copies of $j_2$; we have just increases $n(S,j_2)$ by additive $1$. Since $c_{j_1} \leq c_{j_2}$, the total capacity of $S-j_1+j_2$ exceeds that of $S$. The cardinality of both sets are the same. Therefore, they are valid sets to put $z$-mass on. We keep doing this modification till one of the fractional values become integral. Since for $i$, mass moves from large configurations $(i,\{j\})$ of larger $c_j$-capacity to smaller $c_j$-capacity, this process terminates at one point. At this point, we must have $z(i,\{j_1\}) = 1$; we add $(i,\{j_1\})$ to $\calR$.
%	
	%We perform Step 3 for all large machines. After Step 3, every bucket $B^\brt\setminus \calR$ contains at most one hybrid machine $i_t$ with $z^L(i_t) \in (0,1)$ and small machines $i$ with $z^S(i) = 1$.
%	At the end of it, for every machine $i$ there can be at most one large configuration $\{j\}$ with $z(i,\{j\}) > 0$.\medskip
%	
%	We repeat this step while there  exists a  demand $j \in B^\brt$ for which there are two large configurations, say $(\{p_1\}, j), (\{p_2\}, j)$ with positive $y$ assignments, and suppose $\bc_{p_1} < \bc_{p_2}$ without loss of generality. There are now two cases depending on whether item type $p_1$ is contained in any other non-integrally assigned configuration or not.
%	
%	\medskip \noindent {\bf Case 3b(i): There exists demand $j' \notin \calR$ and configuration $(T,j')$ such that $n(T,p_1) \geq 1$ and $y(T,j') > 0$.}
%	In this case, note that $j'$ may not belong to bucket $t$. Now, if item type $p_2$ is a small item type for demand $j'$, then let $T'$ denote the multi-set obtained from $T$ be adding one item of type $p_2$ and removing one item of type $p_1$. Since $p_1$ has smaller size than $p_2$, clearly the total size of items in $T'$ will exceed that of $T$. On the other hand, if $p_2$ is a large item type for $j'$, then let $T' = \{p_2\}$ and we use the large configuration of $(T',j')$. In both cases, we perform the following updates at a uniform rate: increase $y(\{p_1\},j)$ and $y(T',j')$ and decrease $y(\{p_2\},j)$ and $y(T,j')$, and stop when one of them reaches $0$ or $1$. If in the process some demand is integrally assigned, we include it in $\calR$.
%	
%	\medskip \noindent {\bf Case 3b(ii): There exists no demand $j \notin \calR$ and configuration $(T,j')$ such that $n(T,p_1) \geq 1$ and $y(T,j') > 0$.}
%	In this case, we have at least $1$ free capacity of item type $p_1$, and so we set $y(\{p_1\},j)= 1$ and all other $y(S,j) = 0$ for $S \neq \{i_1\}$. We add $j$ to the rounded set $\calR$ and repeat this step (3b).
%	
%	
%	\begin{claim} \label{fcl:step3b}
%		If $\{y(S,j)\}$ is a feasible to the relaxed configuration LP, then after a single execution of either case 3b(i) or case 3b(ii), the modified solution remains feasible for the relaxed configuration LP, and moreover, invariant~(I) continues holds for all buckets $\leq t-1$.
%	\end{claim}
%	\begin{proof}
%		Again, it is easy to check the feasibility of LP solution much like~\Cref{fcl:swap1}. We also claim that the invariant~[(I1)] continues to hold (for bucket $t-1$) during this process. Indeed, we only need to be worried for the case when $j'$ is of bucket less than $t$, as otherwise we are not modifying the configurations in lower buckets. In this case it will be the unique fractional demand of this bucket guaranteed by invariant~[I1]. Further $(T',j')$ will also be a large configuration for this demand $j'$. Therefore, $y^l(j')$ does not change, and so, the invariant still holds.
%	\end{proof}
%	
%	To summarize, when the process ends, all demands $j \in B^\brt$  except perhaps for one demand satisfy the property that $y^l(j)$ is either 0 or 1. Further, for any demand $j$, there is at most one large configuration $(S,j)$ with positive $y(S,j)$ value. If a large configuration $(\{i\},j)$ satisfies $y(\{i\},j)=1$, then we include $j$ in $\calR$. Thus, for bucket $t$, there is at most one large configuration $(S,j), j \in B^\brt \setminus \calR$  such that $y(S,j)$ strictly between $0$ and $1$. Moreover, since this fractional demand is the demand $j_{k+1}$ identified in Claim~\ref{fcl:step3a}, it has the smallest $f$ among all $j \in B^\brt \setminus \calR$. Thus, we satisfy the invariant for bucket $t$ as well. Observe that right there is exactly one large configuration with positive $y$ value serving $j_k$. However, when we carry out the step (3b) for a bucket larger than $t$, we may redistribute the large assignment of $j$ over several large configurations, but $y^l(j)$ will remain unchanged.
%	

%	\paragraph{Step 2:} This takes input a hybrid machine $i\in B^\brt\setminus \calR$ with the property there exists at least two jobs $j_1$ and $j_2$
%	which are large for $i$, $z(i,\{j_1\}) > 0$ and $z(i,\{j_2\}) > 0$, and neither $j_1$ or $j_2$ are in $\calL$. This subroutine, which is very similar to Fix Large Machine, modifies the LP solution and at the end at least one new job enters $\calL$.
%	
%Let $j_1$ be the smallest capacity job among jobs $j$ with $z(i,\{j\}) > 0$ and $j\notin \calL$. Let $j_2$ be another such job which is guaranteed to exist.
%		%Pick any hybrid  machine $i$ and, after renaming, let $j_1,j_2,\ldots,j_r $ be the jobs in non-decreasing capacity order,  with $z(i,\{j_t\})>0$ for all $1\leq t\leq r$.
%%	Starting with $j_1$, we check if there exists any other machine $i'$ (small or hybrid) and {\em small} configuration $S$ for $i'$ containing $j_1$.
%Since $j_1\notin \calL$, there must exist some machine $i'$  with $z(i',S) > 0$ and $j_1\in S$ for some small configuration $S$. We now move mass precisely as in Step 3.
%Define a set $T$ as follows. If $c_{j_2} > D_{i'}/4\log n$, then $T = \{j_2\}$; otherwise $T = S - j_1 + j_2$. Note that in either case $T \in \calFr_{i'}$.
%	In the first case, $j_2$ is large for $i'$. In the second case, $|T| = |S|$ and $\sum_{j\in T} c_j \ge \sum_{j\in S} c_j$ since $c_{j_2} \geq c_{j_1}$ by choice of $j_1$. We decrease $z(i,\{j_2\})$ and $z(i',S)$ by $\delta$ and increase $z(i,\{j_1\})$ and $z(i',T)$ by $\delta$ till one of the values becomes $0$ or $1$.
%	As before, this preserves the LHS of \eqref{feq:conflp1} and can only decrease the LHS of \eqref{feq:conflp2} (for jobs $j\in S\setminus j_1$ if $T = \{j_2\}$).
%	Unlike Step 3, once we are done with job $j_1$, we won't have $z(i,\{j_1\}) = 1$; either $j_1$ enters $\calL$ or all other jobs enter $\calL$.
%	
%	We keep performing this procedure; once again this procedure increases large-configuration mass on lower capacity configurations, and therefore it will terminate.
%	After termination, we have the following property: for any hybrid machine $i$ and jobs $j_1,\ldots,j_r$ with $z(i,\{j_t\}) > 0$, there can be at most one job $j_t$ which appears
%	in a small configuration of some other machine $i'$ (hybrid or small). For the hybrid machine $i_t$, let this job be $j_t$. Note that $i_t$ and $i_{t'}$ could have the same $j_t$. \smallskip
%	
%	Next, for every hybrid machine $i$ with $z^L(i) < 1 -1/2K$, we simply zero-out their large configuration mass. Note that $z^S(i) > 1/2K$ for all such machines. We rename these machines small.
%	Let $i_1,\ldots,i_{K'}$ be the hybrid machines that remain with $K' \leq K$. Let $J'$ be the jobs which are large for machine in $K'$.
%	Note that $|J'| \geq K'$.

\noindent{\bf Step 3: Taking care of hybrid machines.}

Let $\calH$ be the set of hybrid machines at this point. We know that $|\calH| \leq K \leq \log_2 D$ since each bucket has at most one hybrid machine.
For any machine $i\in \calH$ with $\z^L(i) \le 1-1/K$, we zero-out all its large contribution. More precisely, for all $j$ large for $i$ we set $\z(i,\{j\})= 0$.
Note that \eqref{feq:conflp1} no longer holds, but it holds with RHS $\geq 1/K$. Note that these machines now leave $\calH$ and enter $\calS$.

At this point, for every $i\in \calH$ has $z^L(i) > 1-1/K$. Let $K' := |\calH|$. Let $J'$ be the set of jobs $j$ which are large for some machine $i\in \calH$ and $\z(i,\{j\}) > 0$.
Let $s'_j := s_j - \sum_{i\in \calR} \sum_S \z(i,S)n(S,j)$ be the remaining copies of $j$. Note that it is an integer since $s_j$ was an integer and for all $i\in \calR$, $\z(i,S) \in \{0,1\}$.
Let $G$ be a bipartite graph with $\calH$ on one side and $J'$ on the other with $s'_j$ copies of job $j$. We draw an edge $(i,j)$ iff $j$ is large for $i$ with $\z(i,\{j\}) > 0$.
\begin{claim}
	There is a matching in $G$ matching all $i\in \calH$.
\end{claim}
\begin{proof}
Pick a subset $\calH' \subseteq \calH$ and let $J''$ be its neighborhood in $G$. We need to show $\sum_{j\in J''} s'_j \geq \calH'$.
Since $z$ satisfies \eqref{feq:conflp2}, we get
\[
\sum_{j\in J''} s'_j \geq \sum_{j\in J''} \sum_{i\in \calH'} z(i,\{j\}) = \sum_{i\in \calH'} \sum_{j\in J''} z(i,\{j\})  > (1-1/K)|\calH'| \geq |\calH'| - 1
\]
The first inequality follows since $\z$ satisfies \eqref{feq:conflp2}.
The strict inequality follows since $J''$ is the neighborhood of $\calH'$ and the fact that $z^L(i) > 1-1/K$ for all $i\in \calH$.
The claim follows since $s'_j$'s are integers.
\end{proof}
If machine $i\in \calH$ is matched to job $j$, then we assign $i$ a copy of this job, that is,  set $\z(i,\{j\}) = 1$ and $\z(i,S) = 0$ for all other $S$,
and add $i$ to $\calR$. Let $J_M \subseteq J'$ be the sub(multi)set of jobs allocated; note $|J_M| \leq K \leq \log_2 D$.
After this point all machines outside $\calR$ are small. For every $i\in \calS$ and every small configuration $S$ with $\z(i,S) > 0$, we move this mass to $\z(i,S\setminus J_M)$.
More precisely, $\z(i,S\setminus J_M) = \z(i,S)$ and $\z(i,S) = 0$ for all $i$ and $S$. Note that \eqref{feq:conflp2} is satisfied at this point. Furthermore,
since $\z$ was $(1,1)$-feasible, we know that $\sum_{j\in S} c_j \geq \barD_i$ and for every $j\in S\cap J_M$ we have $c_j \leq \frac{\barD_i}{3\log_2 D}$.
\[
\sum_{j\in S\setminus J_M} c_j \geq  \sum_{j\in S} c_j - |J_M|\cdot \frac{\barD_i}{3\log_2 D} \geq \frac{2\barD_i}{3}
\]
Therefore, we have proved the following claim.
\begin{claim}\label{fclm:007}
At the end of {\bf  Step 3}, we have a solution $\z$ with (a) $\z^L(i) = 0$ for all $i\notin \calR$, (b) $\z$ is $(1,3/2)$-feasible,
(c) $\z$ satisfies \eqref{feq:conflp2}, and satisfies \eqref{feq:conflp1} replaced by $\frac{1}{K} \leq \sum_S \z(i,S) \leq 1$.
%
%we have a set of residual machines $\calS$ and a set of residual jobs $J_{res}$  and a solution $z(i,S)$ where
%\begin{enumerate} [noitemsep]
%	\item For all $i\in \calS$ we have $z(i,S) > 0$ iff $|S| \leq f_i$, $\sum_{j\in S} c_j \geq 3D_i/8$, and $c_j < \frac{D_i}{3\log_2 D}$ for all $j\in S$.
%	\item $\forall i \in \calS, ~ \textstyle 1 \ge \sum_{S} z(i,S)  \geq   1/K \geq \frac{1}{\log_2 D}$.
%	\item $\forall j\in J_{res}, ~ \textstyle \sum_{i} z(i,S)n(S,j)  \leq  s_j$.
%	
%\end{enumerate}
\end{claim}
\smallskip

\noindent
{\bf Step 4: Taking care of Small Machines.}
\def\zz{z^{\mathsf{int}}}
\def\2z{\mathsf z}
We now convert the solution $\z$  to a solution $\2z$ of the assignment LP in the following standard way.
As before, let $s'_j = s_j - \sum_{i\in \calR}\sum_S \z(i,S)n(S,j)$ be the number of jobs remaining.
For every $i\notin \calR$ and $j\in J$ define $\2z_{ij} = \sum_{S}\z(i,S)n(S,j)$.  Note that this satisfies the constraint of the assignment LP:
	\begin{alignat}{4}
		&& \quad \forall j \in J,   &\quad  \textstyle \sum_{i\in \calS} \2z_{ij}  \leq  s'_j \label{feq:1} \\
		&& \quad \forall i\in \calS ,      &\quad  \textstyle \sum_{j\in J}  \2z_{ij}c_j \geq \frac{2\barD_i}{3\log_2 D} \label{feq:2} \\
	&& \quad \forall i\in \calS ,      &\quad  \textstyle \sum_{j\in J}  \2z_{ij} \leq f_i \label{feq:3} \\
		&& \quad \forall i\in \calS, j\in J~\textrm{with}~ \textstyle c_j \geq \frac{\barD_i}{3\log_2 D}, & \quad \2z_{ij}   =  0  \label{feq:4}
	\end{alignat}
	The last equality follows since $\z$ was $(1,8/15)$-feasible and so $\z(i,S) = 0$ for any set $S$ containing a job $j$ with $c_j \geq \frac{\barD_i}{3\log_2 D}$.
The first inequality follows  since $\z$ satisfies \eqref{feq:conflp2}. To see the second and third point, note
that for any $i\in \calS$,
\[
\sum_{j\in J} \2z_{ij}c_j = \sum_j \sum_S \z(i,S)n(S,j)c_j = \sum_S \z(i,S) \sum_j n(S,j)c_j \geq \frac{1}{\log_2 D}\cdot \frac{2\barD_i}{3}
\]
	since $\sum_S \z(i,S) \geq 1/K$ for all $i\in \calS$ and since $\z$ is $(1,3/2)$-feasible, we have $\sum_{j=1}^n n(S,j) c_j \geq \frac{2\barD_i}{3}$. Similarly,
\[
\sum_{j\in J} \2z_{ij} = \sum_j \sum_S \z(i,S)n(S,j) = \sum_S \z(i,S) \sum_j n(S,j) \leq f_i
\]
since for any $S$, $\sum_{j\in S} n(S,j) \leq f_i$ and $\sum_S \z(i,S) \leq 1$.
Now we use Theorem~\ref{fthm:shmoystardos} to find an integral allocation $\zz$ of the jobs $J$ to machines in $\calS$ satisfying \eqref{feq:1},\eqref{feq:3}, and $\sum_{j\in J} \zz_{ij}c_j \geq \frac{\barD_i}{3
\log_2 D}$. \medskip

The final integral assignment is as follows. For every $i\in \calR$, we assign the configuration $S$ with $\z(i,S) = 1$.
Since $\z$ is $(1,3/2)$-feasible, every such machine $i$ gets a total capacity of at least $\frac{\barD_i}{3\log_2 D}$. % \geq \frac{\barD_i}{16\log_2 D}$.
All the remaining machines $i\in \calS$ obtain a set of jobs giving them capacity $\geq \frac{\barD_i}{3\log_2 D}$. %\geq \frac{3D_i}{3\log_2 D}$.
This completes the proof of Lemma~\ref{flem:conf-round}.
\end{proof}

\begin{lemma}\label{flem:conf-is-uf}
$\calP_\mathsf{conf}$ is upward-feasible.
\end{lemma}
\begin{proof}
%\comment{\bf \Large Needs to be written}
Let $s := (s_1,\ldots,s_n)\in \calP_\mathsf{conf}$ for a certain instance of \cckp where the jobs have been renamed so that $c_1\leq \cdots \leq c_n$. We need to prove any non-negative vector $t := (t_1,\ldots,t_n)$ s.t. $t\succeq_\suff s$also lies in $\calP_\mathsf{conf}$.
By the ``hybridization argument'',it suffices to prove the lemma for  $s$ and $t$ differing only in coordinates $\{j-1,j\}$ and $ t_j\ge s_j$ and $t_{j-1} \geq \max(0,s_{j-1} + (s_j - t_j))$.
Given that, we can move from $s$ to $t$ by changing pairs of coordinates each time maintaining feasibility in $\calP_\mathsf{conf}$.

Let $z$ be the solution for the supply vector $s$; we construct a solution $\z$  for the supply vector $t$ starting with $\z = z$.
If $\z$ is not already feasible, then it must be because $s_{j-1} \ge \sum_{i,S} z(i,S)n(S,j-1) > t_{j-1}$.
Therefore, we need to decrease the fractional utilization of job $(j-1)$ by $s_{j-1} - t_{j-1} \leq t_j - s_j$.
For any machine $i$ and any set $S\in \calF_i$ with $z(i,S) > 0$ and $n(S,j-1) \geq 1$ (and this must exist since $t_{j-1}\geq 0$),
define $T := S - \{j-1\} + \{j\}$. Note that $T$ could already have a copy of job $j$; we have $n(T,j) = n(S,j) + 1$. Also note since $c_j \geq c_{j-1}$, if $S\in \calF_i$ then so is $T\in \calF_i$.
We let $\z(i,S) = z(i,S) - \delta$ and $\z(i,T) = z(i,T) + \delta$ till
either $\z(i,S) = 0$ or $\z(i,T) = 1$. Since the total increase of fractional load of job $j$ is exactly the same as the decrease in that of job $j-1$, and we only need total  decrease $(s_{j-1} -t_{j-1}) \leq t_j - s_j$, at the end we get that $\z$ is feasible wrt supply vector $t$.
\end{proof}
\begin{lemma}\label{flem:conf-so}
	$\calP_\mathsf{conf}$ has an $(1+\epsilon)$-approximate separation oracle.
\end{lemma}
\begin{proof}
	Fix $\epsilon> 0$.
	Given a supply vector $s = (s_1,\ldots,s_n)$, we give a polynomial time algorithm which either returns a hyperplane separating $s$ and $\calP_\mathsf{conf}$, or we can assert that
	$s\in \calP_\mathsf{conf}(\calI')$, where $\calI'$ is an instance where machine $i$ has demand $D_i/(1+\epsilon)$. To this end, for every machine $i$, define $\calF^{(\epsilon)}_i := \{S: |S| \leq f_i,  \sum_j c_jn(S,j)\geq D_i/(1+\epsilon) \}$. To prove $s\in \calP_\mathsf{conf}(\calI')$, we need to find $z(i,S)$ defined for all $i\in M, S\in \calF^{(\epsilon)}_i$ satisfying \eqref{feq:conflp1}-\eqref{feq:conflp2}.
	For every $j\in J$, define $\cc_j := (1+\epsilon)c_j$. Note for every $S\in \calF^{(\epsilon)}_i$ iff $|S| \leq f_i$ and  $\sum_{j\in S} \cc_j n(S,j) \geq D_i$.
	
%Let $\cC$ be empty.
Consider the following system of inequalities.
%In this section we show how to solve the LP relaxation given in Section~\ref{fsec:lp}. The set of constraints specify a feasible region for the set of variables $(x_{ijp}, y_{ip})$, which is convex. Therefore, we can invoke the ellipsoid algorithm to solve the LP as long as we can find a separating hyperplane for any infeasible solution. So let $(x_{ijp}, y_{ip})$ be a tentative solution. Since the  constraints in~\eqref{feq:mkc1-full}-\eqref{feq:mkc3-full} are polynomial in number, we can check feasibility for these constraints easily.
%
%
%Consider a {\em fixed} set  of clients $J$.
%We show how to check the constraints~\eqref{feq:proj} for $J$. We re-write the constraints~\eqref{feq:conflpnew} for $J$ below:
%\begin{eqnarray*}
%	\sum_{S \in \calF_J} z_{S,J} & \geq & 1 \\
%	\sum_{S\in \calF_{J}} z_{S,J}\cdot n(S,p) &\leq  & \sum_{i\in \Gamma(J)} y_{ip}  \ \ \ \forall p \in [P] \\
%	z_{S,J} & \geq &  0 \ \ \ \forall S \in \calF_J
%\end{eqnarray*}
%
%Note that we do not explicitly need to say $z_{S,J} \leq 1$ as existence of a solution to the above constraints also guarantees another solution
%which satisfies $z_{S,J} \leq 1$ for all $S \in \calF_J$. Treating $y_{ip}$ values as constants, we know by Farkas' lemma that either there is a feasible solution to
%the above constraints, or there is a feasible solution to the following set of constraints (where the variables are $\alpha_p, p \in [P]$),
%which we call dual LP:
\begin{alignat}{4}
	& \quad \forall j \in J,   &&\quad  \textstyle \alpha_j  \geq 0 \label{feq:d3} \tag{D1} \\
	& \quad  &&\quad  \textstyle \sum_{j\in J}  s_j\cdot \alpha_j  < \sum_{i\in M}\beta_i \label{feq:d1} \tag{D2}\\
	& \quad \forall i\in M, S\in\calF_i, && \quad \textstyle \sum_{j\in J} \alpha_j n(S,j)  \geq \beta_i  \label{feq:d2}  \tag{D3}
\end{alignat}
%\begin{eqnarray}
%\textstyle \sum_{j \in J} s_j \cdot  \alpha_j & < & \textstyle \sum_{i\in M} \beta_i
%\label{feq:d1}\\
%\textstyle \sum_{j \in J} n(S,j) \cdot \alpha_j & \geq & \beta_i \ \ \ \forall i\in M, \forall S \in \calF_i
%\label{feq:d2}\\
%\textstyle \alpha_j & \geq & 0 \label{feq:d3} % \tag{D3}
%\end{eqnarray}
We also need a stronger set of 	inequalities.
\begin{equation}\label{feq:d4}
 \textstyle \forall i\in M, S\in\calF^{(\epsilon)}_i, \quad \sum_{j\in J} \alpha_j n(S,j)  \geq \beta_i  \tag{D4}
\end{equation}
If there exists a feasible solution $(\alpha,\beta)$ to \eqref{feq:d3}-\eqref{feq:d2}, then this forms the hyperplane separating $s$ and $\calP_\mathsf{conf}$ as follows.
This is because for all $t\in \calP_\mathsf{conf}$, if  $z(i,S)$ is the solution feasible for $\calP_\mathsf{conf}$ with $t_j$'s in the RHS of \eqref{feq:conflp2},
then $\sum_{i\in M}\beta_i = \sum_{i\in M} \sum_{S\in \calF_i} \beta_i z(i,S) \leq \sum_{i\in M,S\in \calF_i} z(i,S) \sum_{j\in J} \alpha_jn(S,j) \leq \sum_{j\in J} \alpha_j t_j$.
The following claim proves the lemma.\smallskip

\begin{claim}
In polynomial time, we can either find $(\alpha,\beta)$ feasible for \eqref{feq:d3}-\eqref{feq:d2}, or we can find variables $z(i,S)$ for $i\in M,S\in \calF^{(\epsilon)}_i$ satisfying
\eqref{feq:conflp1}-\eqref{feq:conflp2}.
\end{claim}
\begin{proof}
We run the ellipsoid algorithm to check feasibility of the stronger system \eqref{feq:d3},\eqref{feq:d1}, and \eqref{feq:d4}.
At any point, we have a running iterate $(\alpha,\beta)$. %The non-trivial part is to find a separation oracle for \eqref{feq:d2}.
%That is, we need to find $i\in M$, and  a set $S\in \calF_i$ such that $\sum_j \alpha_jn(S,j) < \beta_i$. Unfortunately this is an NP-hard problem and we need to resort to approximation as follows.
For every $i\in M$, maximize $\sum_j \cc_j n(S,j)$ over all subsets $S$ with $|S|\leq f_i$ and $\sum_{j\in J} \alpha_j n(S,j) < \beta_i$.
There is an FPTAS for this problem~\cite{CapraraKPP00}. If the maximum value returned by the approximation scheme is {\em smaller} than $D_i$, then
we know that the true optimum is $\leq D_i(1+\epsilon)$. That is, for every $S$ with $|S| \leq f_i$ and $\sum_{j\in J}\alpha_j n(S,j) < \beta_i$, we have $\sum_{j\in J} \cc_jn(S,j) \le D_i(1+\epsilon)$.
Which in turn implies $\sum_{j\in J} c_jn(S,j) \leq D_i$. Contrapositively, for every $S\in \calF_i$, we must have $\sum_{j\in J} \alpha_j n(S,j) \geq \beta_i$. %implying $(\alpha,\beta)$.
That is $(\alpha,\beta)$ satisfies \eqref{feq:d3}-\eqref{feq:d2} and we exit.
%satisfies \eqref{feq:d1}-\eqref{feq:d3} and we can exit.

Otherwise, the PTAS  returns a set $S^\star$ with $|S^\star|\le f_i$ and $\sum_{j\in J}\cc_j n(S,j) \geq D_i$, that is $S^\star \in \calF^{(\epsilon)}_i$, for which
$\sum_{j\in J}\alpha_j n(S^\star,j) < \beta_i$. We add $(i,S^\star)$ to $\cC$, and return $(\alpha,\beta)$ to the separation oracle for \eqref{feq:d4}.
%We also add $(i,S^\star)$ to $\calC$.
The ellipsoid algorithm states than in polynomial time we either find an $(\alpha,\beta)$ feasible for \eqref{feq:d3}-\eqref{feq:d2}, or the polynomially many hyperplanes
in $\calC$ prove \eqref{feq:d3},\eqref{feq:d1}, and \eqref{feq:d4} is infeasible.
More precisely, there exists a solution $z$ satisfying \eqref{feq:conflp1}-\eqref{feq:conflp2} with $z(i,S)$ defined for $(i,S)\in \calC$.
Since $|\cC|$ is bounded by a polynomial, we can explicitly find $z$ by solving the LP \eqref{feq:conflp1}-\eqref{feq:conflp2} with variables $z(i,S)$ for $(i,S)\in \calC$.
\end{proof}\end{proof}
%Now, if there is no feasible solution to the above set of constraints, then we know that the solution $y \in \calP(J)$. Otherwise, if there is a
%feasible solution, then the first constraint  gives a separating hyperplane. Thus, it is enough to find a solution to the above set of constraints, or
%declare that it is infeasible. We check the above constraints again by the ellipsoid algorithm. Thus, given $\alpha_p$ values we need to check that
%for all $S \in \calF_J$, $\sum_{p \in [P]} n(S,p) \cdot \alpha_p \leq 1$. We can restate the  problem as a general version of the knapsack cover
%problem. We are given a knapsack of capacity 1. We are also given $n_p$ items of size $\alpha_p$ and profit $c_p$ each. We would like to
%select at most $|\Gamma(J)|$ items which cover  the knapsack, i.e., whose total $\alpha_p$ values add up to at least $1$, and maximize the
%total profit. If we can get profit at least $D(J)$, we know that there is a violating constraint (given by the set of items $S$)  to the above set
%of constraints; otherwise the values $\alpha_p$ are feasible. This general version of knapsack cover can be solved exactly using dynamic programming.
%Using standard rounding techniques, we can give an FPTAS for this problem (\textcolor{red}{Do we need a reference here?}). Thus, we can give a polynomial
%time algorithm which given the values $\alpha_p$ either (i) declares that the dual LP is infeasible (and so, $y \in \calP(J)$), or (ii) declares that
%$\alpha_p$ values are feasible even if  we relax the  set $\calF_J$ to a set $\calF_J^\varepsilon$ defined as : $\{S\in \Supp: |S| \leq |\Gamma(J)|, \sum_{p\in S} c_p \geq (1- \varepsilon) D(J)\}$, where $\varepsilon$ is an arbitrarily small constant. Thus, in terms of the primal LP,
%we get an algorithm which either declares (i) $y \in \calP(J)$, or (ii) finds a separating hyperplane with respect to $\calP(J)$ where we modify $\calF_J$ to
%$\calF_J^\varepsilon$. Running the ellipsoid algorithm (and assuming that the configuration LP is feasible), we can ensure that for a fixed $J$,
%we get a solution $y$ which lies in $\calP(J)$ provided we change $\calF_J$ to $\calF_J^\varepsilon$.


%\end{proof}


%\subsection{Assignment LP for $Q|f_i|C_{min}$}
%Suppose we are given $m$ machines $M$ with cardinality constraints $f_1,\ldots,f_m$, and $n$ types of  jobs $J$ with capacities $c_1 \geq \cdots \geq c_n$.
%Let $(s_1,\ldots, s_n)$ be a supply vector, that is, there are $s_j$ copies of job $j$.
%Suppose there exists a feasible solution to the following LP.
%\begin{alignat}{4}
%	&& \quad \forall j\in J,  &\quad  \textstyle \sum_{i\in M} z_{ij} \leq s_j \label{feq:asslp1} \\
%	&& \quad \forall i\in M,  &\quad  \textstyle \sum_{j\in J} c_jz_{ij}  \geq D_i \label{feq:asslp2}\\
%	&&\quad \forall i\in M, & \quad \textstyle \sum_{j\in J} z_{ij}  \leq  f_i \label{feq:asslp3}\\
%	&& \quad \forall i\in \calS, j\in J_{res} ~\textrm{with}~ c_j \geq C_i, & \quad z_{ij}   =  0   \label{feq:asslp4}
%\end{alignat}
%\def\zz{z^{\mathsf{int}}}
%%For the correct guess, the above LP is feasible. If so, using the fact that $c_p \leq T_i$ for all $i\sim p$, we can get a feasible solution with a slight hit in the demand.
%\begin{theorem}\label{fthm:shmoystardos}
%	If \eqref{feq:asslp1}-\eqref{feq:asslp4} is feasible, then there is an integral assignment $\zz_{ij}$ which satisfies \eqref{feq:asslp1}, \eqref{feq:asslp3} and \eqref{feq:asslp4}, and
%	$\quad \forall i\in M, ~~ \sum_{j\in J} c_j\zz_{ij}  \geq D_i - C_i$.
%\end{theorem}
%\begin{proof} {\large NEEDS BETTER WRITING} We repeat the argument of Shmoys and Tardos~\cite{bibid}.
%Form $\floor{\sum_{j\in J} z_{ij}} \le f_i$ copies of every machine; let $N_i$ be the copies of machine $i$. Order the jobs with multiplicities s.t. $c_1 \geq c_2 \geq \cdots \geq c_N$ where $N = \sum_j s_j$.
%Modify $z_{ij}$ to get an assigment $z_{ij}$ for $i\in \cup N_i$ and $j\in [N]$ as follows. We do this for one machine $i$.
%
%Given $z_{ij}$'s we form $|N_i| + 1$ groups $S_1,\ldots, S_{|N_i|},S_{|N_i|+1}$ with $\sum_{j\in S_t} z_{ij} =1$ for all $1\leq t\leq |N_i|$ and $\sum_{j\in S_t} z_{ij} < 1$ for $t = |N_i|+1$.
%Note that $\sum_{j\in S_t} z_{ij}c_j < c_{j'}$ for $j'\in S_{t-1}$. When we do this modification for all machines, we get a fractional matching solution where all the $N_i$ copies get fractional value $1$ but the jobs are at most $1$.
%So, there is an integral matching. The total integral load on machine $i$ is at least $\sum_{t>1} \sum_{j\in S_t} z_{ij}c_j \geq D_i - C_i$ since $z_{ij} = 0$ for $c_j > C_i$.
%	
%	Cardinality constraint vacuously satisfied.
%\end{proof}

\subsection{Integrality Gap}\label{fsec:conf-ig}
In this section we prove Theorem~\ref{fthm:conf-ig}.
%We show that the configuration LP for the problem of allocating jobs to machines of different speeds to maximize the minimum processing time has super-constant integrality gap.
%\begin{theorem}
%	The integrality gap of CLP is $\Omega(\log n/\log\log n)$.
%\end{theorem}
%\begin{proof}
	\def\M{\mathcal{M}}
	Fix $K$. We present an instance $\calI_K$ for which configuration LP is feasible but any integral allocation must violate the demand of some machine by factor $K$.
	
	First we describe the machines in $\calI_K$.
	\begin{enumerate}
		\item There is $1$ machine $M_0$ with $D(M_0) = 1$ and $f(M_0) = 1$.
		\item There are $K$ machines $M_1,\ldots,M_K$ with $D(M_i) = K^{-i}$ and $f_i := f(M_i) = K^{2K + 1}\cdot K^{-2i}$.
		\item There are $K$ {\bf classes} of machines $\M_1,\M _2,\ldots, \M _K$. Machines in the same class are equivalent.
		There are $f_i$ machines in $\M_i$ and they are numbered $N^{(i)}_1,\ldots,N^{(i)}_{f_i}$.
		Each machine $N$  in class $i$ has $D(N) = \frac{1}{f_iK^i} = K^{-(2K+ 1)}\cdot K^i$ and $f(N) = 1$.
	\end{enumerate}
	Now we describe the jobs.
	\begin{enumerate}
		\item There are $K$ ``big jobs'' $J_1,\ldots,J_K$ with $c(J_i) = 1$.
		\item There are $K$ other types of jobs of the same capacity. Job $J$ of type $i$ has capacity $c(J) = c_i :=  \frac{1}{f_iK^i} = K^{-(2K+1)}K^i$  and there are $n_i := f_i (1+1/K) = (K+1)K^{2K}K^{-2i}$ of them.
		We divide these $n_i$ jobs into two sets $S_i \cup T_i$ where $|S_i| = f_i$ and $|T_i| = f_i/K$. We order the jobs in $S_i$ arbitrarily and call them $P^{(i)}_1,\cdots,P^{(i)}_{f_i}$.
	\end{enumerate}
	So, the total number of machines in $\calI_K$ are $1 + K + \sum_{i=1}^K f_i  \leq K^{2K}$ and the number of jobs is $K + (1+1/K)\sum_{i=1}^K f_i \approx K^{2K}$.
	
	\begin{lemma}
		The Configuration LP is feasible.
	\end{lemma}
	\begin{proof}
		We describe a fractional solution.
		\begin{enumerate}
			\item For machine $M_0$ we satisfy as follows: set  $y(M_0,J_i) = 1/K$ for $i=1,\ldots,K$. Note $c(J_i) \geq D(M_0)$ and $|J_i| = 1 = f(M_0)$.
			\item For machine $M_i$ we satisfy as follows: set $y(M_i,J_i) = 1-1/K$ and $y(M_i,S_i) = 1/K$. Recall $S_i$ are the $f_i$ jobs of type $i$.
			\begin{itemize}
				\item Note $c(J_i) = 1 \geq D(M_i) = K^{-i}$ and 	$|J_i| = 1 \leq f(M_i) = K^{2K+1}K^{-2i}$ since $i\leq K$.
				\item Note $c(S_i) = |S_i|\cdot \frac{1}{f_iK^i} = \frac{1}{K^i} = D(M_i)$. Note $|S_i| = f_i = f(M_i)$.
			\end{itemize}
			\item For $1\leq i\leq K$, for a machine $N^{(i)}_j$ in class $i$, where $1\leq j\leq f_i$, we satisfy it as follows: $y(N^{(i)}_j, P^{(i)}_j) = 1-1/K$ and $y(N^{(i)}_j, t) = 1/f_i$ for all $t\in T_i$.
			Since $|T_i| = f_i/K$, the total fractional $y$-amount that $N^{(i)}_j$ gets is $1$. Also note that $N^{(i)}_j$ gets singleton jobs of type $i$ whose capacity is $\frac{1}{f_iK_i} = D(N^{(i)}_j)$.
		\end{enumerate}
		We need to show that no job is over allocated.
		\begin{enumerate}
			\item The big jobs $J_i$ is given $1/K$ to $M_0$ and $(1-1/K)$ to $M_i$.
			\item For $1\leq i\leq K$, $1\leq j\leq f_i$, job $P^{(i)}_j \in S_i$ is given $1/K$ to $M_i$ and $(1-1/K)$ to $N^{(i)}_j\in \M_i$.
			\item For $1\leq i\leq K$, job $t\in T_i$ is given $1/f_i$ to the $f_i$ machines of $\M_i$.
		\end{enumerate}
		This completes the description of the feasible solution.
	\end{proof}
	\begin{lemma}
		The integral optimum must violate some machine by factor $\Omega(K)$.
	\end{lemma}
	\begin{proof}
		Lets take machines in $\M_i$. Recall all machines here have demand of $\frac{1}{f_iK^i}$ and cardinality constraint of $1$.
		Thus in the integral optimum, they {\bf must} get one job which is either big, or of type $i$ or larger.
		Now, the total number of jobs of type $j > i$ are
		\[
		\sum_{j>i} f_j(1+1/K) = (K+1)K^{2K} \sum_{j > i} K^{-2j} \leq  (K+1)K^{2K}K^{-2i} \sum_{\ell=1}^\infty K^{-2\ell} = O\left(f_i/K\right)
		\]
		So, at least $(1 - \Theta(1/K))f_i$ of the machines in $\M_i$ get a job of type $i$ (or a big job but lets assume for now this don't happen -- can be ma).
		Therefore, the number of type $i$ jobs left after satisfying machines $(M_0,\ldots,M_K)$ are only $\Theta(f_i/K)$.
		
		
		Now take a machine $M_i$. We have $f(M_i) = f_i$ and $D(M_i) = 1/K^i$.
		First note that jobs of type $j < i$ are ``useless'' for $M_i$. Any $f_i$ of them (best to take them of type $(i-1)$)  gives capacity $f_i\cdot c_{i-1}  = \frac{f_i}{f_{i-1}K^{i-1}} = \frac{1}{K^{i+1}} =  \frac{1}{K}\cdot D(M_i)$. So any subset of these jobs that can fit in $M_i$ gives capacity $\leq D(M_i)/K$.
		On the other hand, the total capacity of jobs remaining from type $j \geq i$ is  $\sum_{j\geq i} \Theta(f_j/K)\cdot \frac{1}{f_jK^j} = \Theta(1/K)\sum_{j\geq i} \frac{1}{K^j} = \Theta(D(M_i)/K)$.
		
		Therefore, any machine $M_i$ can't get more than $D(M_i)/K$ from the ``small'' jobs. But then they all can't get big jobs.
	\end{proof}
	The above two lemmas prove the theorem after noting that $K = \Theta(\log n/\log\log n)$ where $n$ is either the number of machines of jobs.
%\end{proof}
